<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <h1>WebSocket è¿æ¥æµ‹è¯•</h1>
    <button id="connectBtn" onclick="connect()">å»ºç«‹ WebSocket è¿æ¥</button>
    <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
    <div id="status" class="disconnected">æœªè¿æ¥</div>

    <script>
        let ws = null;
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');

        // é˜²æ­¢é¡µé¢æ„å¤–åˆ·æ–°/å…³é—­
        window.addEventListener('beforeunload', function (e) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.warn('âš ï¸ é¡µé¢å³å°†å…³é—­,WebSocket è¿æ¥ä¼šæ–­å¼€');
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                console.log('ğŸ“´ é¡µé¢éšè—');
            } else {
                console.log('ğŸ“± é¡µé¢å¯è§');
            }
        });

        function connect() {
            const url = 'http://localhost:9000/user/ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMDFjMjEwNzItNDdjNi00NTNmLWExMjItZDJiNGRiZjRjMjE2IiwiaXNzIjoiYWktbmV4dXMtYXV0aCIsImV4cCI6MTc2MzkwOTAxOCwiaWF0IjoxNzYzMzA0MjE4fQ.KW28eZqSpwHB8JSi3LCgoAkGB1JCPVhm3_Dtu9IhTIY';

            // å°† http è½¬æ¢ä¸º ws åè®®
            const wsUrl = url.replace('http://', 'ws://');

            console.log('æ­£åœ¨è¿æ¥åˆ°:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = function (event) {
                console.log('âœ… WebSocket è¿æ¥å·²å»ºç«‹', event);
                statusDiv.textContent = 'å·²è¿æ¥';
                statusDiv.className = 'connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            };

            ws.onmessage = function (event) {
                console.log('ğŸ“¨ æ”¶åˆ°æ¨é€æ¶ˆæ¯:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    console.log('ğŸ“¦ è§£æåçš„æ•°æ®:', data);

                    // å¤„ç† ping/pong
                    if (data.type === 'ping') {
                        console.log('ğŸ“ æ”¶åˆ° ping,å‘é€ pong');
                        ws.send(JSON.stringify({ type: 'pong' }));
                    }
                } catch (e) {
                    console.log('ğŸ“„ åŸå§‹æ–‡æœ¬æ¶ˆæ¯:', event.data);
                }
            };

            ws.onerror = function (error) {
                console.error('âŒ WebSocket é”™è¯¯:', error);
            };

            ws.onclose = function (event) {
                console.log('ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­', event);
                console.log('ğŸ” å…³é—­ä»£ç :', event.code);
                console.log('ğŸ” å…³é—­åŸå› :', event.reason);
                console.log('ğŸ” æ˜¯å¦æ­£å¸¸å…³é—­:', event.wasClean);
                statusDiv.textContent = 'æœªè¿æ¥ (code: ' + event.code + ')';
                statusDiv.className = 'disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
    </script>
</body>

</html>